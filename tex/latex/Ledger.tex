\begin{code}%
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{Ledger}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Prelude}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Utils}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Cripto}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Transactions}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{RawTransactions}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{TXTree}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{ledgerOutNoId}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{outputs}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaRecord{TXField}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{addr}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Address}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Amount}\<%
\\
\>[0]\AgdaFunction{ledgerOutNoId}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{addr}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
\>[0]\AgdaFunction{ledgerOutNoId}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{output}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{outputs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{addr}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaField{TXField.address}\AgdaSpace{}%
\AgdaBound{output}\AgdaSpace{}%
\AgdaOperator{\AgdaField{==}}\AgdaSpace{}%
\AgdaBound{addr}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{yes}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaField{TXField.amount}\AgdaSpace{}%
\AgdaBound{output}\AgdaSpace{}%
\AgdaOperator{\AgdaField{+}}\AgdaSpace{}%
\AgdaFunction{ledgerOutNoId}\AgdaSpace{}%
\AgdaBound{outputs}\AgdaSpace{}%
\AgdaBound{addr}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{no}%
\>[10]\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{ledgerOutNoId}\AgdaSpace{}%
\AgdaBound{outputs}\AgdaSpace{}%
\AgdaBound{addr}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{ledgerOut}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{outputs}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaRecord{TXFieldWithId}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{addr}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Address}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Amount}\<%
\\
\>[0]\AgdaFunction{ledgerOut}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{addr}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
\>[0]\AgdaFunction{ledgerOut}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{output}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{outputs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{addr}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaField{TXFieldWithId.address}\AgdaSpace{}%
\AgdaBound{output}\AgdaSpace{}%
\AgdaOperator{\AgdaField{==}}\AgdaSpace{}%
\AgdaBound{addr}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{yes}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaField{TXFieldWithId.amount}\AgdaSpace{}%
\AgdaBound{output}\AgdaSpace{}%
\AgdaOperator{\AgdaField{+}}\AgdaSpace{}%
\AgdaFunction{ledgerOut}\AgdaSpace{}%
\AgdaBound{outputs}\AgdaSpace{}%
\AgdaBound{addr}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{no}%
\>[10]\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{ledgerOut}\AgdaSpace{}%
\AgdaBound{outputs}\AgdaSpace{}%
\AgdaBound{addr}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{{-}{-} ledgerTree : (rawTXTree : RawTXTree) (addr : Address) → Amount}\<%
\\
\>[0]\AgdaComment{{-}{-} ledgerTree txTree = ledgerOut outputs}\<%
\\
\>[0]\AgdaComment{{-}{-}   where open RawTXTree txTree}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{{-}{-} deltaRawTX : (tx : RawTX) (addr : Address) → Int}\<%
\\
\>[0]\AgdaComment{{-}{-} deltaRawTX (coinbase record \{ outputs = outputs \}) = pos ∘ ledgerOut outputs}\<%
\\
\>[0]\AgdaComment{{-}{-} deltaRawTX (normalTX record \{ inputs = [] ; outputs = outputs \}) addr =}\<%
\\
\>[0]\AgdaComment{{-}{-}   pos \$ ledgerOutNoId outputs addr}\<%
\\
\>[0]\AgdaComment{{-}{-} deltaRawTX (normalTX record \{ inputs = (record \{ time = \AgdaUnderscore{} ; position = \AgdaUnderscore{} ; amount = amount ; msg = \AgdaUnderscore{} ;}\<%
\\
\>[0]\AgdaComment{{-}{-}   signature = \AgdaUnderscore{} ; publicKey = pk \} ∷ inputs) ; outputs = outputs \}) addr}\<%
\\
\>[0]\AgdaComment{{-}{-}   with addr == publicKey2Address pk}\<%
\\
\>[0]\AgdaComment{{-}{-} ... | yes \AgdaUnderscore{} = deltaRawTX (normalTX (record \{ inputs = inputs ; outputs = outputs \})) addr {-} pos amount}\<%
\\
\>[0]\AgdaComment{{-}{-} ... | no  \AgdaUnderscore{} = deltaRawTX (normalTX (record \{ inputs = inputs ; outputs = outputs \})) addr}\<%
\end{code}
